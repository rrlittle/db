{% extends "db/base_template.html" %}
{% block content %}

<h1 style="text-align:center">
	<input type="hidden" name="surveyid" id="surveyid" value="{{ surveyid }}">
	{{surveytitle}}
</h1>
<hr>

{% if NoRespondents %}
	<h1>Cannot Submit answers when no respondents available</h1>
	<button onclick="alert('Work In Progress')"> add a respondent </button>

{% else %}
<form id='post_survey'>
	{% csrf_token %} {#	allow form submission #}
	<label>date of response</label>
	<input type="date" name="date_of_response" id='dateofresponse'>
	
	{# Who is responding to this #}
	<select class="respondent form-control" style="width:auto" id="respondent">
		<option style="display:none" value="-1">select a respondent</option>
		{% for respondent in respondents %}
			<option value="{{ respondent.id }}">{{ respondent.display }}</option>
		{% endfor %}
	</select>

	{# Display all the questions #}
	{% for question in survey.questions %}
		{# the whole question entity #}
		<div class="question well panel-default" 
			handlingflag="{{question.handlingflag}}" 
			id="{{ question.surveyquestionid }}">
			{# question prompt #}
			<div class="questionprompt panel-heading">
				{{ question.prompt }}
			</div>
			{# the choices for this question #}
			<div class="choiceset panel-body">
				{% for choice in question.choices %}
					{# each choice #}
					<label>{{ choice.description }}</label>
					<input class="choice" 
						type="{{ choice.ui }}" 
						name="{{ question.surveyquestionid }}" 
						id="{{ choice.id }}"
						value="{{ choice.defaultvalue }}">
					{# this means that radio/text/checkbox are the #}
					{# most likely scenarios.  #}
					{# if it's a radio. you should only create one answer on the server #}
					{# if it's a checkbox. you should create one answer for each selected choice #}
					{# if it's a textbox. you should create one answer for each choice. #}
					{# they will by default be filled with the default answers #}
				{% endfor %}
			</div>
		</div>
	{% endfor %}
	{# allow submisssion of form #}
	<input type="submit" name="submit">
</form>


<script type="text/javascript">
	$(document).ready( function() {
    	$('#dateofresponse')[0].valueAsDate = new Date();
	});

	$(document).on('submit', '#post_survey', function(e){
		e.preventDefault();

		function handle_checkbox(questionid){
			var ret = {}
			var selected_choices = $('.question#' + questionid +'>>.choice:checked')
			return ret
		}

		var data = {
				csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
				respondentid: $('#respondent').val(),
				dateofresponse: $('#dateofresponse').val(),
				surveyid: $('input[name=surveyid]').val(),
		}

		var questionblocks = $('.question')
		for (i=0; i < questionblocks.length; i++){
			var question = questionblocks[i]
			var questionid = question.id
			var question_handling = question.getAttribute('handlingflag')
			
			if (question_handling == "checkbox"){
				$.extend(data, handle_checkbox(questionid))
			}

			var choices = $('.question#' + questionid + '>>.choice:checked')
			for (var j = choices.length - 1; j >= 0; j--) {
				var choice = choices[j]
				console.log(choice, question_handling)
			}
		}


		console.log('posting data:', data)
		$.ajax({
			type: 'POST',
			url: '{% url "db:post_survey" %}',
			data: data,
			success: function(resp, status){
				console.log('recieved',resp);
			}
		})
	});
</script>
{% endif %}


{% endblock content %}



